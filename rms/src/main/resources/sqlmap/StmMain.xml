<?xml version="1.0" encoding="UTF-8"?>
 <!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd"> 

<mapper namespace="com.daekyo.rms.stm.dao.StmMainDAO"> 

	<resultMap type="stmMainVO" id="stmMain1">
		<id column="totalcnt" 			property="totalcnt" />
		<id column="rnum" 				property="rnum" />
		<id column="zrms_ym" 			property="zrms_ym" />
		<id column="zemp_nm" 			property="zemp_nm" />
		<id column="zemp_id" 			property="zemp_id" />
		<id column="zregion" 			property="zregion" />
		<id column="zregion_nm" 		property="zregion_nm" />
		<id column="zdept_id"			property="zdept_id" />
		<id column="zdept_nm" 			property="zdept_nm" />
		<id column="zdept_brch_id" 		property="zdept_brch_id" />
		<id column="zlc_nm" 			property="zlc_nm" />
		<id column="zreq_cnt" 			property="zreq_cnt" />
		<id column="zreq_vol" 			property="zreq_vol" />
		<id column="zmon_cnt" 			property="zmon_cnt" />
		<id column="zreq_non_vol" 		property="zreq_non_vol" />
		<id column="zmon_cnt_p" 		property="zmon_cnt_p" />
		<id column="zgrund_01_c" 		property="zgrund_01_c" />
		<id column="zgrund_01" 			property="zgrund_01" />
		<id column="zgrund_04_c" 		property="zgrund_04_c" />
		<id column="zgrund_04" 			property="zgrund_04" />
		<id column="zgrund_06_c" 		property="zgrund_06_c" />
		<id column="zgrund_06" 			property="zgrund_06" />
		<id column="zgrund_03_c" 		property="zgrund_03_c" />
		<id column="zgrund_03" 			property="zgrund_03" />
		<id column="zgrund_05_c" 		property="zgrund_05_c" />
		<id column="zgrund_05" 			property="zgrund_05" />
		<id column="zgrund_07_c" 		property="zgrund_07_c" />
		<id column="zgrund_07" 			property="zgrund_07" />
		<id column="zgrund_etc_c" 		property="zgrund_etc_c" />
		<id column="zgrund_etc" 		property="zgrund_etc" />
	</resultMap>
	
	<select id="getStmApply" parameterType="HashMap" resultMap="stmMain1" > 
		WITH RMS_STMNG_D AS
		(
				SELECT ZRMS_YM 
				      , (SELECT ZNM FROM ZSD7_LOGIN WHERE MANDT = '300' AND KUNNR = A.ZEMP_ID AND ROWNUM = 1) AS ZEMP_NM
				      , ZEMP_ID
				      , ZREGION
				      , (SELECT NAME1 FROM ZFIT010 WHERE MANDT = '300' AND BRANCH = A.ZREGION) AS ZREGION_NM
				      , ZDEPT_ID
				      , (SELECT NAME1 FROM ZFIT010 WHERE MANDT = '300' AND BRANCH = A.ZDEPT_ID) AS ZDEPT_NM
				      , ZDEPT_BRCH_ID
				      , ZLC_NM
				      , ZREQ_CNT	
				      , ZREQ_VOL	
				      , ZMON_CNT	
				      , ZREQ_NON_VOL
				      , RTRIM(TO_CHAR(ROUND(DECODE(ZMON_CNT, 0, 0, (ZREQ_VOL / ZMON_CNT)*100), 1), 'FM9990.00'), '.') AS ZMON_CNT_P
				      , ZGRUND_01 AS ZGRUND_01_C
				      , TO_CHAR(ROUND(DECODE(ZREQ_VOL, 0, 0, (ZGRUND_01 / ZREQ_VOL)*100), 1)) AS ZGRUND_01-- 신입(복회)
				      , ZGRUND_04 AS ZGRUND_04_C	
				      , TO_CHAR(ROUND(DECODE(ZREQ_VOL, 0, 0, (ZGRUND_04 / ZREQ_VOL)*100), 1)) AS ZGRUND_04 -- 진도변경(오류)
				      , ZGRUND_06 AS ZGRUND_06_C
				      , TO_CHAR(ROUND(DECODE(ZREQ_VOL, 0, 0, (ZGRUND_06 / ZREQ_VOL)*100), 1)) AS ZGRUND_06 -- 교재추가 불출
				      , ZGRUND_03 AS ZGRUND_03_C
				      , TO_CHAR(ROUND(DECODE(ZREQ_VOL, 0, 0, (ZGRUND_03 / ZREQ_VOL)*100), 1)) AS ZGRUND_03 -- 전환
				      , ZGRUND_05 AS ZGRUND_05_C
				      , TO_CHAR(ROUND(DECODE(ZREQ_VOL, 0, 0, (ZGRUND_05 / ZREQ_VOL)*100), 1)) AS ZGRUND_05 -- 입회 유도샘플
				      , ZGRUND_07 AS ZGRUND_07_C
				      , TO_CHAR(ROUND(DECODE(ZREQ_VOL, 0, 0, (ZGRUND_07 / ZREQ_VOL)*100), 1)) AS ZGRUND_07 -- 진도 미입력
				      , (ZGRUND_02+ZGRUND_08+ZGRUND_09+ZGRUND_10+ZGRUND_11+ZGRUND_12+ZGRUND_13+ZGRUND_14+ZGRUND_15+ZGRUND_16) AS ZGRUND_ETC_C
				      , TO_CHAR(ROUND(DECODE(ZREQ_VOL, 0, 0, ((ZGRUND_02+ZGRUND_08+ZGRUND_09+ZGRUND_10+ZGRUND_11+ZGRUND_12+ZGRUND_13+ZGRUND_14+ZGRUND_15+ZGRUND_16) / ZREQ_VOL)*100), 1)) AS ZGRUND_ETC -- 기타
				FROM ZSD7_RMS_STMNG_D A
				WHERE MANDT = '300'
				<if test='session_zregion_gb == "A"'>
					<if test='active_bcg_id == "N"'>
						AND (ZREGION LIKE 'T3%' OR ZREGION = 'T802' OR ZREGION = 'T410') -- T410 : 성장사업본부
					</if>
					<if test='active_bcg_id == "C"'>
						AND ZREGION = 'T880'
					</if>
					<if test='active_bcg_id == "S"'>
						AND ZREGION = 'T885'
					</if>
				</if>
				<if test='session_zregion_gb != "A"'>
					<if test='session_zregion_gb == "N"'>
						AND (ZREGION LIKE 'T3%' OR ZREGION = 'T802')
					</if>
					<if test='session_zregion_gb == "C"'>
						AND ZREGION = 'T880'
					</if>
					<if test='session_zregion_gb == "S"'>
						AND ZREGION = 'T885'
					</if>
				</if>
				
				<if test='zreq_ym_a != null and zreq_ym_a != ""'>
					<if test='zreq_ym_b != null and zreq_ym_b != ""'>
						AND ZRMS_YM BETWEEN #{zreq_ym_b} AND #{zreq_ym_a}
					</if>
				</if>
				<if test="session_zauth_grp == 'N1' or session_zauth_grp == 'N0' or session_zauth_grp == 'NS' or session_zauth_grp == 'NA' or session_zauth_grp == 'NI'">
					<choose>
						<when test="session_zauth_grp == 'NI'">
							<if test='session_zregion_gb != "A"'>
								AND ZREGION = #{zregion}
								<if test='zdept_id != null and zdept_id != ""'>
									AND ZDEPT_ID = #{zdept_id}
								</if>
								<if test='zdept_brch_id != null and zdept_brch_id != ""'>
									AND ZDEPT_BRCH_ID = #{zdept_brch_id}
								</if>
								<if test='zemp_id != null and zemp_id != ""'>
									AND ZEMP_ID = #{zemp_id}
								</if>
							</if>
						</when>
						<otherwise>
							<if test='zregion != null and zregion != ""'>
								AND ZREGION = #{zregion}
							</if>
							<if test='zdept_id != null and zdept_id != ""'>
								AND ZDEPT_ID = #{zdept_id}
							</if>
							<if test='zdept_brch_id != null and zdept_brch_id != ""'>
								AND ZDEPT_BRCH_ID = #{zdept_brch_id}
							</if>
							<if test='zemp_id != null and zemp_id != ""'>
								AND ZEMP_ID = #{zemp_id}
							</if>
						</otherwise>
					</choose>
				</if>
				<if test="session_zauth_grp == 'NC' or session_zauth_grp == 'NP'">
					AND ZREGION = #{session_zregion}
					AND ZDEPT_ID = #{session_zdept_id}
					<if test='zdept_brch_id != null and zdept_brch_id != ""'>
						AND ZDEPT_BRCH_ID = #{zdept_brch_id}
					</if>
					<if test='zemp_id != null and zemp_id != ""'>
						AND ZEMP_ID = #{zemp_id}
					</if>
				</if>
				<if test="session_zauth_grp == 'NX' ">
					AND ZREGION = #{session_zregion}
					<if test='zdept_id != null and zdept_id != ""'>
						AND ZDEPT_ID = #{zdept_id}
					</if>
					<if test='zdept_brch_id != null and zdept_brch_id != ""'>
						AND ZDEPT_BRCH_ID = #{zdept_brch_id}
					</if>
					<if test='zemp_id != null and zemp_id != ""'>
						AND ZEMP_ID = #{zemp_id}
					</if>
				</if>
				ORDER BY ZRMS_YM DESC, ZREGION, ZDEPT_ID, ZDEPT_BRCH_ID, ZEMP_ID
		)	
        SELECT *
        FROM(
            SELECT ROWNUM AS RNUM, A.*, B.TOTALCNT
            FROM RMS_STMNG_D A
                , (SELECT COUNT(1) AS TOTALCNT
                   FROM RMS_STMNG_D) B
        )
        WHERE 1 = 1
		AND RNUM <![CDATA[ <= ]]> (#{page}*1) * 20
		AND RNUM <![CDATA[ > ]]> ((#{page}*1) - 1) * 20
	</select>
	
</mapper>
